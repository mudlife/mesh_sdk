C51 COMPILER V9.53.0.0   FLASH                                                             07/02/2019 12:32:36 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE FLASH
OBJECT MODULE PLACED IN .\Objects\flash.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE dev\flash.c LARGE OPTIMIZE(6,SPEED) BROWSE INCDIR(.\app;.\dev;.\os;.\inc
                    -) DEFINE(LOG,LIGHT) DEBUG OBJECTEXTEND PRINT(.\Listings\flash.lst) TABS(2) OBJECT(.\Objects\flash.obj)

line level    source

   1          /**
   2           * @file flash.c
   3           * @brief Flash操作文件
   4           * @details 实现Flash的读写擦除以及校验操作
   5           * @author mudlife
   6           * @par Copyright (c):
   7           *      上海晶曦微电子科技有限公司
   8           * @version 1.0.0
   9           * @date 2019-06-02
  10           */
  11          #include "flash.h"
  12          #include <string.h>
  13          
  14          /**
  15           * @brief 擦除 flash
  16           * @param addr 擦除地址
  17           * @return 无
  18           * @note 一次擦除128 byte
  19           */
  20          void flash_erase_section(u16 addr)
  21          {
  22   1        EA = 0;
  23   1        IAP_CMD = 0xF00F;       //Flash解锁
  24   1        IAP_ADDR = addr;      //写入擦除地址
  25   1        IAP_CMD = 0xD22D;       //选择操作方式， 扇区擦除
  26   1        IAP_CMD = 0xE11E;         //触发后IAP_ADDRL&IAP_ADDRH指向0xFF，同时自动锁定
  27   1        EA = 1;
  28   1      }
  29          
  30          /**
  31           * @brief 从flash中读取数据
  32           * @param addr 起始地址
  33           * @param buf 读取缓存
  34           * @param len 读取长度
  35           * @return 无
  36           */
  37          void flash_read_buf(u16 addr,u8 *buf,u8 len)
  38          {
  39   1      
  40   1          while(len--)
  41   1        *(buf++)=*((unsigned char code *)(addr++));//读取数据
  42   1      }
  43          
  44          /**
  45           * @brief 往flash中写入数据
  46           * @param addr 起始地址
  47           * @param buf 数据缓存
  48           * @param len 写入长度长度
  49           * @return 无
  50           * @note 写之前要先判断是否需要擦除
  51           */
  52          void flash_write_buf(u16 addr,u8 *buf,u8 len)
  53          {
  54   1        EA = 0;
C51 COMPILER V9.53.0.0   FLASH                                                             07/02/2019 12:32:36 PAGE 2   

  55   1        while(len--)
  56   1        {   
  57   2          IAP_DATA=*buf;  //待编程数据，写入数据寄存器必须放在解锁之前
  58   2          IAP_CMD=0xF00F;       //Flash解锁
  59   2          IAP_ADDR=addr;    //写入地址
  60   2          IAP_CMD=0xB44B;       //字节编程
  61   2          IAP_CMD=0xE11E;       //触发一次操作
  62   2          addr++;       //地址加一
  63   2          buf++;        //数据后移一位
  64   2        }
  65   1        EA = 1;
  66   1      }
  67          
  68          /**
  69           * @brief 从flash中读取mac 地址
  70           * @param addr 起始地址
  71           * @param buf 读取缓存
  72           * @return 无
  73           */
  74          void flash_read_mac_addr(u16 addr,u8 *buf)
  75          {
  76   1        u8 i;
  77   1        for(i=0;i<6;i++){
  78   2          buf[5-i] = *((unsigned char code *)(addr++));//读取数据
  79   2        }
  80   1      }
  81          
  82          /**
  83           * @brief flash信息校验
  84           * @param dat 校验数据
  85           * @param len 数据长度
  86           * @return 校验值
  87           */
  88          u8 flash_crc(u8 *dat,u8 len)
  89          {
  90   1        u8 i;
  91   1        u8 crc = 0;
  92   1        for(i=0;i<len;i++){
  93   2          crc ^= dat[i];
  94   2        }
  95   1        
  96   1        return crc;
  97   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    260    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      19
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
