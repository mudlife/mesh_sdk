C51 COMPILER V9.53.0.0   SYSTEM                                                            07/19/2019 11:47:17 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN .\Objects\system.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE dev\system.c LARGE OPTIMIZE(6,SPEED) BROWSE INCDIR(.\app;.\dev;.\os;.\in
                    -c) DEFINE(LOG,LIGHT) DEBUG OBJECTEXTEND PRINT(.\Listings\system.lst) TABS(2) OBJECT(.\Objects\system.obj)

line level    source

   1          /**
   2           * @file system.c
   3           * @brief 系统文件
   4           * @details 用于芯片系统初始化，系统时钟初始化和时钟中断处理
   5           * @author mudlife
   6           * @par Copyright (c):
   7           *      上海晶曦微电子科技有限公司
   8           * @version 1.0.0
   9           * @date 2019-06-02
  10           */
  11          #include "system.h"
  12          #include "network_conf.h"
  13          
  14          data u32 g_time=0;          ///<全局时间
  15          //extern u8 adv_flag;
  16          extern u8 task_tick; 
  17          //extern u8 update_time_flag;
  18          
  19          
  20          extern void F_CWRunning(void);
  21          
  22          /**
  23           * @brief 系统初始化
  24           * 
  25           * @return 无
  26           * @note 初始化定时器0，用作滴答定时器
  27           */
  28          void system_init(void)
  29          {
  30   1        
  31   1        WDTCCR = 0x00;            //关闭看门狗
  32   1        while((CLKCON&0x20)!=0x20);     //等待内部高频RC起振
  33   1        CLKSWR = 0x51;            //选择内部高频时钟为主时钟，内部高频RC2分频，Fosc=16MHz
  34   1        while((CLKSWR&0xC0)!=0x40);     //等待内部高频切换完成
  35   1        CLKDIV = 0x01;            //Fosc1分频得到Fcpu，Fcpu=16MHz 
  36   1        FREQ_CLK = 0x10;          //指明当前系统时钟8
  37   1        
  38   1      
  39   1        TCON1 = 0x00;           //Tx0定时器时钟为Fosc
  40   1        TMOD = 0x00;            //16位重装载定时器/计数器
  41   1      
  42   1        //Tim0计算时间  = (65536 - 0xFACB) * (1 / (Fosc /Timer分频系数))
  43   1        //        = 1333 / (16000000 / 12)
  44   1        //        = 1 ms
  45   1      
  46   1        //定时1ms
  47   1        //反推初值  = 65536 - ((1/1000) / (1/(Fosc / Timer分频系数)))
  48   1        //        = 65536 - ((1/1000) / (1/(16000000 / 12)))
  49   1        //      = 65536 - 1333
  50   1        //      = 0xFACB
  51   1        TH0 = 0xFA;
  52   1        TL0 = 0xCB;             //T0定时时间1ms
  53   1        IE |= 0x02;             //打开T0中断
  54   1        TCON |= 0x10;           //使能T0
C51 COMPILER V9.53.0.0   SYSTEM                                                            07/19/2019 11:47:17 PAGE 2   

  55   1          
  56   1        EA = 1;               //打开总中断
  57   1      }
  58          
  59          /**
  60           * @brief 看门狗初始化
  61           * 
  62           * @return 无
  63           */
  64          void wdt_init(void)
  65          {
  66   1        WDTC = 0x57;   //允许WDT复位，允许掉电/空闲模式下运行，1024分频
  67   1        WDTCCR = 0xFF;  //5.93S
  68   1      }
  69          
  70          /**
  71           * @brief T0中断服务函数
  72           *
  73           * @return 无
  74           */
  75          void TIMER0_Rpt(void) interrupt TIMER0_VECTOR
  76          {
  77   1        g_time++;
  78   1        task_tick = 1;
  79   1        
  80   1        if(g_time%50 == 0){
  81   2          system_tdma();
  82   2      //    P0_0 = ~P0_0;
  83   2        }
  84   1        F_CWRunning();
  85   1      }
  86          
  87          /**
  88           * @brief   跳频
  89           *
  90           * @return 无
  91           */
  92          void system_tdma(void)
  93          {
  94   1        local_info.channel = ++local_info.channel%3;
  95   1      }
  96          
  97          
  98          /**
  99           * @brief   复位不重读代码选项
 100           *
 101           * @return 无
 102           */
 103          void ResetNoReadOption(void)
 104          {
 105   1        IAP_CMD = 0xF00F;
 106   1        IAP_CMD = 0x8778;
 107   1      }
 108          
 109          
 110          /**
 111            * @说明   复位重读代码选项
 112            * @参数   无
 113            * @返回值 无
 114            * @注    无
 115            */
 116          //void ResetReadOption(void)
C51 COMPILER V9.53.0.0   SYSTEM                                                            07/19/2019 11:47:17 PAGE 3   

 117          //{
 118          //  IAP_CMD = 0xF00F;
 119          //  IAP_CMD = 0x7887;
 120          //}


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    218    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
